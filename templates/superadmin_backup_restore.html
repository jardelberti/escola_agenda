{% extends "base.html" %}

{% block title %}Backup e Restauração do Sistema{% endblock %}

{% block content %}
<body class="bg-slate-50" style='font-family: Inter, "Noto Sans", sans-serif;'>
    <div class="container mx-auto px-4 py-8">
        
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800">Backup e Restauração do Sistema</h1>
            <div class="mt-4 sm:mt-0">
                <a href="{{ url_for('superadmin_dashboard') }}" class="bg-slate-200 text-slate-700 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition-colors">Voltar ao Dashboard</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="space-y-2 mb-6">
                {% for category, message in messages %}
                    {% set color = 'blue' if category == 'success' else 'red' if category == 'danger' else 'yellow' %}
                    <div class="bg-{{ color }}-100 border-l-4 border-{{ color }}-500 text-{{ color }}-700 p-4 rounded-lg" role="alert">
                        <p>{{ message }}</p>
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Gerar Backup Completo</h3>
                <p class="text-slate-600 mb-4">
                    Gera e baixa um arquivo de backup completo de <strong>todo o banco de dados</strong> (todas as escolas).
                    Guarde este arquivo em um local seguro.
                </p>
                <a href="{{ url_for('backup_database') }}" class="w-full inline-block text-center bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-green-700">
                    <span class="material-symbols-outlined align-middle text-base">download</span> Baixar Backup Agora
                </a>
            </div>

            <div class="bg-white p-6 rounded-xl border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Restaurar Backup Completo</h3>
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-4" role="alert">
                    <p class="font-bold">Atenção! Ação Irreversível!</p>
                    <p>Restaurar um backup irá <strong>sobrescrever permanentemente</strong> todos os dados de todas as escolas. O sistema pode ficar indisponível durante o processo.</p>
                </div>
                
                <form action="{{ url_for('restore_database') }}" method="POST" enctype="multipart/form-data" id="restoreForm">
                    <div class="mb-4">
                        <label for="backup_file" class="block text-sm font-medium text-slate-600 mb-1">Arquivo de Backup (.sql ou .db)</label>
                        <input type="file" name="backup_file" id="backup_file" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
                    </div>
                    <div class="flex items-start mb-4">
                        <input id="confirm_restore" type="checkbox" value="" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 mt-1">
                        <label for="confirm_restore" class="ml-2 text-sm font-medium text-slate-700">Eu entendo que esta ação substituirá todos os dados atuais.</label>
                    </div>
                    <button type="submit" id="restoreButton" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span class="material-symbols-outlined align-middle text-base">upload</span> Restaurar do Arquivo
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const confirmCheckbox = document.getElementById('confirm_restore');
        const restoreButton = document.getElementById('restoreButton');
        const fileInput = document.getElementById('backup_file');

        function checkFormState() {
            // O botão só é habilitado se a caixa estiver marcada E um arquivo for selecionado
            if (confirmCheckbox.checked && fileInput.files.length > 0) {
                restoreButton.disabled = false;
            } else {
                restoreButton.disabled = true;
            }
        }

        // Adiciona 'listeners' para verificar o estado sempre que houver uma mudança
        confirmCheckbox.addEventListener('change', checkFormState);
        fileInput.addEventListener('change', checkFormState);
    });
    </script>
</body>
{% endblock %}