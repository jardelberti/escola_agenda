{% extends "base.html" %}

{% block title %}Gerenciar Planos{% endblock %}

{% block content %}
<body class="bg-slate-50" style='font-family: Inter, "Noto Sans", sans-serif;'>
    <div class="container mx-auto px-4 py-8">

        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800">Gerenciar Planos</h1>
            <div class="mt-4 sm:mt-0">
                <a href="{{ url_for('superadmin_dashboard') }}" class="bg-slate-200 text-slate-700 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition-colors">Voltar ao Dashboard</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="space-y-2 mb-6">
                {% for category, message in messages %}
                    {% set color = 'blue' if category == 'success' else 'red' if category == 'danger' else 'yellow' %}
                    <div class="bg-{{ color }}-100 border-l-4 border-{{ color }}-500 text-{{ color }}-700 p-4 rounded-lg" role="alert">
                        <p>{{ message }}</p>
                    </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl border border-slate-200 sticky top-8">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Adicionar Novo Plano</h3>
                    <form method="POST" action="{{ url_for('manage_plans') }}" class="space-y-4">
                        <div>
                            <label for="nome" class="block text-sm font-medium text-slate-600 mb-1">Nome do Plano</label>
                            <input type="text" name="nome" class="w-full rounded-lg border-slate-300" placeholder="Ex: Mensal" required>
                        </div>
                        <div>
                            <label for="preco" class="block text-sm font-medium text-slate-600 mb-1">Preço (R$)</label>
                            <input type="text" name="preco" class="w-full rounded-lg border-slate-300" placeholder="Ex: 99,90" required>
                        </div>
                        <div>
                            <label for="duracao_meses" class="block text-sm font-medium text-slate-600 mb-1">Duração (Meses)</label>
                            <input type="number" name="duracao_meses" class="w-full rounded-lg border-slate-300" placeholder="Ex: 1 para mensal, 12 para anual" required>
                        </div>
                        <div>
                            <label for="stripe_price_id" class="block text-sm font-medium text-slate-600 mb-1">Stripe Price ID</label>
                            <input type="text" name="stripe_price_id" class="w-full rounded-lg border-slate-300" placeholder="price_xxxxxxxxxxxx" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700">Adicionar Plano</button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-200">
                        <h3 class="text-xl font-bold text-slate-800">Planos Existentes</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Preço</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Stripe ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                {% for plano in planos %}
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">{{ plano.nome }} ({{ plano.duracao_meses }}m)</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">R$ {{ "%.2f"|format(plano.preco / 100) }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-mono text-xs">{{ plano.stripe_price_id }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                        <button type="button" class="bg-yellow-100 text-yellow-800 font-semibold px-3 py-1.5 rounded-md text-sm hover:bg-yellow-200"
                                                data-bs-toggle="modal" data-bs-target="#editPlanModal"
                                                data-plan-id="{{ plano.id }}"
                                                data-plan-nome="{{ plano.nome }}"
                                                data-plan-preco="{{ "%.2f"|format(plano.preco / 100) }}"
                                                data-plan-duracao="{{ plano.duracao_meses }}"
                                                data-plan-stripeid="{{ plano.stripe_price_id }}">
                                            Editar
                                        </button>
                                        <button type="button" class="bg-red-100 text-red-800 font-semibold px-3 py-1.5 rounded-md text-sm hover:bg-red-200"
                                                data-bs-toggle="modal" data-bs-target="#deletePlanModal"
                                                data-plan-id="{{ plano.id }}"
                                                data-plan-nome="{{ plano.nome }}">
                                            Excluir
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editPlanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Editar Plano</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form id="editPlanForm" method="POST">
                <div class="modal-body space-y-4">
                    <div><label class="form-label">Nome</label><input type="text" class="form-control" name="nome" id="edit_nome" required></div>
                    <div><label class="form-label">Preço (R$)</label><input type="text" class="form-control" name="preco" id="edit_preco" required></div>
                    <div><label class="form-label">Duração (Meses)</label><input type="number" class="form-control" name="duracao_meses" id="edit_duracao" required></div>
                    <div><label class="form-label">Stripe Price ID</label><input type="text" class="form-control" name="stripe_price_id" id="edit_stripeid" required></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
            </form>
        </div></div>
    </div>
    
    <div class="modal fade" id="deletePlanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Confirmar Exclusão</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o plano <strong id="deletePlanName"></strong>?</p>
                <p class="text-danger small mt-2">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><a id="deletePlanButton" href="#" class="btn btn-danger">Sim, Excluir</a></div>
        </div></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const editPlanModal = document.getElementById('editPlanModal');
            editPlanModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const planId = button.dataset.planId;
                
                const form = editPlanModal.querySelector('#editPlanForm');
                form.action = `/superadmin/plans/edit/${planId}`;
                form.querySelector('#edit_nome').value = button.dataset.planNome;
                form.querySelector('#edit_preco').value = button.dataset.planPreco;
                form.querySelector('#edit_duracao').value = button.dataset.planDuracao;
                form.querySelector('#edit_stripeid').value = button.dataset.planStripeid;
            });

            const deletePlanModal = document.getElementById('deletePlanModal');
            deletePlanModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const planId = button.dataset.planId;
                const planName = button.dataset.planNome;
                
                deletePlanModal.querySelector('#deletePlanName').textContent = planName;
                deletePlanModal.querySelector('#deletePlanButton').href = `/superadmin/plans/delete/${planId}`;
            });
        });
    </script>
</body>
{% endblock %}